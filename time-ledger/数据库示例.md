# 数据库示例数据

本文档展示了 Time Ledger 系统中各个核心表的示例数据，帮助理解数据结构和业务逻辑。

> **注意**：所有敏感信息（地址、哈希）已脱敏处理。

## 1. balance_log - 余额变动事实表

记录所有 Transfer 事件导致的余额变动。

| id | chain_id | contract_address | account | delta | balance_after | block_number | block_time | tx_hash | log_index | created_at |
|----|----------|------------------|---------|-------|---------------|--------------|------------|---------|-----------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 1000 | 1000 | 10032846 | 2026-01-13 05:20:36 | 0x8a68...52b0 | 657 | 2026-01-17 11:50:13 |
| 2 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -100 | 900 | 10034697 | 2026-01-13 11:59:12 | 0x83ed...fc49 | 43 | 2026-01-17 11:53:39 |
| 3 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 100 | 100 | 10034697 | 2026-01-13 11:59:12 | 0x83ed...fc49 | 43 | 2026-01-17 11:53:39 |
| 4 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -150 | 750 | 10034699 | 2026-01-13 11:59:48 | 0x3595...8ecf | 31 | 2026-01-17 11:53:40 |
| 5 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 150 | 150 | 10034699 | 2026-01-13 11:59:48 | 0x3595...8ecf | 31 | 2026-01-17 11:53:40 |
| 6 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -90 | 660 | 10038756 | 2026-01-14 01:54:48 | 0x671e...2117 | 123 | 2026-01-17 12:01:18 |
| 7 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 90 | 190 | 10038756 | 2026-01-14 01:54:48 | 0x671e...2117 | 123 | 2026-01-17 12:01:18 |
| 8 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -160 | 500 | 10038757 | 2026-01-14 01:55:00 | 0x2104...a6e8 | 48 | 2026-01-17 12:01:18 |
| 9 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 160 | 310 | 10038757 | 2026-01-14 01:55:00 | 0x2104...a6e8 | 48 | 2026-01-17 12:01:18 |
| 10 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -310 | 190 | 10046276 | 2026-01-15 03:01:00 | 0x97cc...4a8e | 2 | 2026-01-17 12:15:03 |
| 11 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 310 | 500 | 10046276 | 2026-01-15 03:01:00 | 0x97cc...4a8e | 2 | 2026-01-17 12:15:03 |
| 12 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | -70 | 120 | 10046278 | 2026-01-15 03:01:24 | 0x3e6e...1e12 | 3 | 2026-01-17 12:15:04 |
| 13 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 70 | 380 | 10046278 | 2026-01-15 03:01:24 | 0x3e6e...1e12 | 3 | 2026-01-17 12:15:04 |
| 14 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | -70 | 430 | 10053039 | 2026-01-16 01:47:24 | 0x2081...b2d3 | 25 | 2026-01-17 12:36:50 |
| 15 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 70 | 450 | 10053039 | 2026-01-16 01:47:24 | 0x2081...b2d3 | 25 | 2026-01-17 12:36:50 |
| 16 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 1000 | 1000 | 36258216 | 2026-01-13 06:12:00 | 0x8d18...4732 | 66 | 2026-01-17 14:17:26 |
| 17 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | -110 | 890 | 36268659 | 2026-01-13 12:00:06 | 0x17be...7387 | 107 | 2026-01-17 14:17:26 |
| 18 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 110 | 110 | 36268659 | 2026-01-13 12:00:06 | 0x17be...7387 | 107 | 2026-01-17 14:17:26 |
| 19 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | -130 | 760 | 36268682 | 2026-01-13 12:00:52 | 0xef0c...45e0 | 24 | 2026-01-17 14:17:26 |
| 20 | 84532 | 0xB8a3...3dF6 | 0x5697...1552 | 130 | 130 | 36268682 | 2026-01-13 12:00:52 | 0xef0c...45e0 | 24 | 2026-01-17 14:17:26 |
| 21 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | -80 | 680 | 36293673 | 2026-01-14 01:53:54 | 0x81d0...525a | 22 | 2026-01-17 14:46:16 |
| 22 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 80 | 190 | 36293673 | 2026-01-14 01:53:54 | 0x81d0...525a | 22 | 2026-01-17 14:46:16 |
| 23 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | -60 | 620 | 36293683 | 2026-01-14 01:54:14 | 0xed12...a565c | 29 | 2026-01-17 14:46:20 |
| 24 | 84532 | 0xB8a3...3dF6 | 0x5697...1552 | 60 | 190 | 36293683 | 2026-01-14 01:54:14 | 0xed12...a565c | 29 | 2026-01-17 14:46:20 |

**关键字段说明**：
- `chain_id`：链 ID（11155111=Sepolia, 84532=Base Sepolia）
- `contract_address`：合约地址
- `account`：用户地址
- `delta`：余额变动量（正数为收入，负数为支出，单位：wei，显示时已除以 10^18）
- `balance_after`：变动后的余额快照（单位：wei，显示时已除以 10^18）
- `block_number`：区块号
- `block_time`：区块时间
- `tx_hash`：交易哈希
- `log_index`：日志索引
- `created_at`：记录创建时间

**业务逻辑**：
- 每个 Transfer 事件产生 2 条记录（from 和 to）
- 唯一索引：`(chain_id, contract_address, account, block_number, log_index)`
- 用于积分计算的事实数据源
- 同一笔交易的转出和转入记录具有相同的 `tx_hash` 和 `log_index`

---

## 2. block_cursor - 同步进度表

记录每条链的同步进度，用于断点续传。

| id | chain_id | contract_address | block_number | block_hash | scan_block_number | updated_at |
|----|----------|------------------|--------------|------------|-------------------|------------|
| 4 | 11155111 | 0xBEfe...C073 | 10064675 | 0x0600...5179 | 10064675 | 2026-01-17 16:38:58 |
| 5 | 84532 | 0xB8a3...3dF6 | 36293683 | 0x3750...0b90 | 36315683 | 2026-01-17 16:39:50 |

**关键字段说明**：
- `chain_id`：链 ID
- `contract_address`：合约地址
- `block_number`：已确认的区块高度（写入数据库）
- `block_hash`：已确认区块的哈希
- `scan_block_number`：已扫描的区块高度（可能在 Redis pending）
- `updated_at`：更新时间

**业务逻辑**：
- 对于 OP Stack 链：`scan_block_number` > `block_number`（扫描快于确认）
- 用于断点续传和同步进度追踪

---

## 3. block_header - 区块头信息表

用于 OP Stack 链的分叉检测。

| id | chain_id | contract_address | block_number | block_hash | parent_hash | block_time | created_at |
|----|----------|------------------|--------------|------------|-------------|------------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 10032846 | 0x8b3f...0ac5 | 0xf574...5142 | 2026-01-13 05:20:36 | 2026-01-17 11:50:13 |
| 2 | 11155111 | 0xBEfe...C073 | 10034697 | 0x60f5...1860 | 0x7ee6...8560 | 2026-01-13 11:59:12 | 2026-01-17 11:53:39 |
| 3 | 11155111 | 0xBEfe...C073 | 10034699 | 0x09ae...d16b | 0x514f...cd0a | 2026-01-13 11:59:48 | 2026-01-17 11:53:40 |
| 4 | 11155111 | 0xBEfe...C073 | 10038756 | 0xb239...0452 | 0xd3ed...3042 | 2026-01-14 01:54:48 | 2026-01-17 12:01:18 |
| 5 | 11155111 | 0xBEfe...C073 | 10038757 | 0x2388...bd61 | 0xb239...0452 | 2026-01-14 01:55:00 | 2026-01-17 12:01:18 |
| 6 | 11155111 | 0xBEfe...C073 | 10046276 | 0x6c7f...3afd | 0x6284...a4e0 | 2026-01-15 03:01:00 | 2026-01-17 12:15:03 |
| 7 | 11155111 | 0xBEfe...C073 | 10046278 | 0xb209...3d12 | 0xa682...4688 | 2026-01-15 03:01:24 | 2026-01-17 12:15:04 |
| 8 | 11155111 | 0xBEfe...C073 | 10053039 | 0x8b26...8718 | 0x25d2...bbd2 | 2026-01-16 01:47:24 | 2026-01-17 12:36:50 |
| 9 | 84532 | 0xB8a3...3dF6 | 36258216 | 0x3cf5...7eac | 0xcdcf...ba29 | 2026-01-13 06:12:00 | 2026-01-17 14:17:26 |
| 10 | 84532 | 0xB8a3...3dF6 | 36268659 | 0xb493...e231 | 0x6904...1aae | 2026-01-13 12:00:06 | 2026-01-17 14:17:26 |
| 11 | 84532 | 0xB8a3...3dF6 | 36268682 | 0x6154...b008 | 0x0af9...7bed | 2026-01-13 12:00:52 | 2026-01-17 14:17:26 |
| 12 | 84532 | 0xB8a3...3dF6 | 36293673 | 0x0bc7...671b | 0x9e20...93d5 | 2026-01-14 01:53:54 | 2026-01-17 14:46:16 |
| 13 | 84532 | 0xB8a3...3dF6 | 36293683 | 0x3750...0b90 | 0x40ad...0858 | 2026-01-14 01:54:14 | 2026-01-17 14:46:20 |

**关键字段说明**：
- `block_hash`：区块哈希
- `parent_hash`：父区块哈希
- `block_time`：区块时间
- `created_at`：记录创建时间

**业务逻辑**：
- 存储最近 N 个区块的哈希（N = reorg_window）
- 定期与链上实际哈希对比，检测分叉
- 发现不一致时触发回滚

---

## 4. point_rate - 积分费率配置表

配置不同时间段的积分计算费率。

| id | chain_id | contract_address | rate_numerator | rate_denominator | effective_time | created_at |
|----|----------|------------------|----------------|------------------|----------------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 5 | 100 | 1970-01-01 00:00:00 | 2026-01-17 11:27:44 |
| 2 | 11155111 | 0xBEfe...C073 | 8 | 100 | 2026-01-15 03:01:00 | 2026-01-17 11:27:44 |
| 3 | 84532 | 0xB8a3...3dF6 | 5 | 100 | 1970-01-01 00:00:00 | 2026-01-17 11:27:44 |
| 4 | 84532 | 0xB8a3...3dF6 | 8 | 100 | 2026-01-15 03:01:00 | 2026-01-17 11:27:44 |

**费率说明**：
- 费率 = `rate_numerator / rate_denominator`
- 示例：5/100 = 0.05 (5%)，8/100 = 0.08 (8%)
- 支持动态调整：2026-01-15 之后费率从 5% 提升到 8%
- `effective_time`：费率生效时间

**业务逻辑**：
- 积分计算时根据时间段选择对应费率
- 费率变更时会拆分积分计算区间

---

## 5. user_balance - 用户余额快照表

存储用户当前余额的最新状态。

| id | chain_id | contract_address | account | balance | block_number | block_time | updated_at |
|----|----------|------------------|---------|---------|--------------|------------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 120 | 10046278 | 2026-01-15 03:01:24 | 2026-01-17 12:15:04 |
| 2 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 430 | 10053039 | 2026-01-16 01:47:24 | 2026-01-17 12:36:50 |
| 3 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 450 | 10053039 | 2026-01-16 01:47:24 | 2026-01-17 12:36:50 |
| 4 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 620 | 36293683 | 2026-01-14 01:54:14 | 2026-01-17 14:46:20 |
| 5 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 190 | 36293673 | 2026-01-14 01:53:54 | 2026-01-17 14:46:16 |
| 6 | 84532 | 0xB8a3...3dF6 | 0x5697...1552 | 190 | 36293683 | 2026-01-14 01:54:14 | 2026-01-17 14:46:20 |

**关键字段说明**：
- `balance`：当前余额（单位：wei，显示时已除以 10^18）
- `block_number`：最后更新的区块号
- `block_time`：最后更新的区块时间
- `updated_at`：记录更新时间

**业务逻辑**：
- 每次 Transfer 事件后更新
- 可通过 `balance_log` 重建（用于分叉回滚）
- 用于快速查询用户当前余额

---

## 6. user_point - 用户积分快照表

存储用户累计积分的最新状态。

| id | chain_id | contract_address | account | total_points | last_calc_time | updated_at |
|----|----------|------------------|---------|--------------|----------------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 1185.722 | 2026-01-16 01:47:24 | 2026-01-17 15:31:37 |
| 2 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 1700.763 | 2026-01-16 01:47:24 | 2026-01-17 15:31:37 |
| 3 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 1219.048 | 2026-01-16 01:47:24 | 2026-01-17 15:31:37 |
| 4 | 84532 | 0xB8a3...3dF6 | 0x5697...1552 | 90.281 | 2026-01-14 01:54:14 | 2026-01-17 15:31:37 |
| 5 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 818.429 | 2026-01-14 01:54:14 | 2026-01-17 15:31:37 |
| 6 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 76.484 | 2026-01-14 01:54:14 | 2026-01-17 15:31:37 |

**关键字段说明**：
- `total_points`：累计积分
- `last_calc_time`：上次计算的截止时间
- `updated_at`：记录更新时间

**业务逻辑**：
- 每小时整点计算一次
- `last_calc_time`：上次计算的截止时间
- 程序重启后根据 `last_calc_time` 回溯历史积分


---

## 7. user_point_log - 积分计算明细表

记录每个时间段的积分计算详情，用于审计和追溯。

| id | chain_id | contract_address | account | balance | from_time | to_time | points | rate_numerator | rate_denominator | created_at |
|----|----------|------------------|---------|---------|-----------|---------|--------|----------------|------------------|------------|
| 1 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 150 | 2026-01-13 11:59:48 | 2026-01-14 01:55:00 | 104.400 | 5 | 100 | 2026-01-17 15:31:37 |
| 2 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 310 | 2026-01-14 01:55:00 | 2026-01-15 03:01:00 | 389.050 | 5 | 100 | 2026-01-17 15:31:37 |
| 3 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 310 | 2026-01-15 03:01:00 | 2026-01-15 03:01:24 | 0.165 | 8 | 100 | 2026-01-17 15:31:37 |
| 4 | 11155111 | 0xBEfe...C073 | 0x5697...1552 | 380 | 2026-01-15 03:01:24 | 2026-01-16 01:47:24 | 692.107 | 8 | 100 | 2026-01-17 15:31:37 |
| 5 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 1000 | 2026-01-13 05:20:36 | 2026-01-13 11:59:12 | 332.167 | 5 | 100 | 2026-01-17 15:31:37 |
| 6 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 900 | 2026-01-13 11:59:12 | 2026-01-13 11:59:48 | 0.450 | 5 | 100 | 2026-01-17 15:31:37 |
| 7 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 750 | 2026-01-13 11:59:48 | 2026-01-14 01:54:48 | 521.875 | 5 | 100 | 2026-01-17 15:31:37 |
| 8 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 660 | 2026-01-14 01:54:48 | 2026-01-14 01:55:00 | 0.110 | 5 | 100 | 2026-01-17 15:31:37 |
| 9 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 500 | 2026-01-14 01:55:00 | 2026-01-15 03:01:00 | 627.500 | 5 | 100 | 2026-01-17 15:31:37 |
| 10 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 190 | 2026-01-15 03:01:00 | 2026-01-15 03:01:24 | 0.101 | 8 | 100 | 2026-01-17 15:31:37 |
| 11 | 11155111 | 0xBEfe...C073 | 0x8a89...5Dd1 | 120 | 2026-01-15 03:01:24 | 2026-01-16 01:47:24 | 218.560 | 8 | 100 | 2026-01-17 15:31:37 |
| 12 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 100 | 2026-01-13 11:59:12 | 2026-01-14 01:54:48 | 69.633 | 5 | 100 | 2026-01-17 15:31:37 |
| 13 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 190 | 2026-01-14 01:54:48 | 2026-01-15 03:01:00 | 238.482 | 5 | 100 | 2026-01-17 15:31:37 |
| 14 | 11155111 | 0xBEfe...C073 | 0xe9FC...c259 | 500 | 2026-01-15 03:01:00 | 2026-01-16 01:47:24 | 910.933 | 8 | 100 | 2026-01-17 15:31:37 |
| 15 | 84532 | 0xB8a3...3dF6 | 0x5697...1552 | 130 | 2026-01-13 12:00:52 | 2026-01-14 01:54:14 | 90.281 | 5 | 100 | 2026-01-17 15:31:37 |
| 16 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 1000 | 2026-01-13 06:12:00 | 2026-01-13 12:00:06 | 290.083 | 5 | 100 | 2026-01-17 15:31:37 |
| 17 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 890 | 2026-01-13 12:00:06 | 2026-01-13 12:00:52 | 0.569 | 5 | 100 | 2026-01-17 15:31:37 |
| 18 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 760 | 2026-01-13 12:00:52 | 2026-01-14 01:53:54 | 527.588 | 5 | 100 | 2026-01-17 15:31:37 |
| 19 | 84532 | 0xB8a3...3dF6 | 0x8a89...5Dd1 | 680 | 2026-01-14 01:53:54 | 2026-01-14 01:54:14 | 0.189 | 5 | 100 | 2026-01-17 15:31:37 |
| 20 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 110 | 2026-01-13 12:00:06 | 2026-01-14 01:53:54 | 76.432 | 5 | 100 | 2026-01-17 15:31:37 |
| 21 | 84532 | 0xB8a3...3dF6 | 0xe9FC...c259 | 190 | 2026-01-14 01:53:54 | 2026-01-14 01:54:14 | 0.053 | 5 | 100 | 2026-01-17 15:31:37 |

**关键字段说明**：
- `balance`：该时间段内的余额（单位：wei，显示时已除以 10^18）
- `from_time`：计算起始时间
- `to_time`：计算结束时间
- `points`：该时间段获得的积分
- `rate_numerator`：费率分子
- `rate_denominator`：费率分母
- `created_at`：记录创建时间

**积分计算示例**：

以 id=1 为例：
```
余额：150 token
时长：2026-01-13 11:59:48 → 2026-01-14 01:55:00 = 13小时55分12秒 ≈ 13.92 小时
费率：5/100 = 0.05
积分：150 × 13.92 × 0.05 = 104.40
```

以 id=3 为例（费率变更时刻）：
```
余额：310 token
时长：2026-01-15 03:01:00 → 2026-01-15 03:01:24 = 24秒 ≈ 0.00667 小时
费率：8/100 = 0.08（新费率生效）
积分：310 × 0.00667 × 0.08 = 0.165
```

以 id=16 为例（Base Sepolia 链）：
```
余额：1000 token
时长：2026-01-13 06:12:00 → 2026-01-13 12:00:06 = 5小时48分6秒 ≈ 5.8017 小时
费率：5/100 = 0.05
积分：1000 × 5.8017 × 0.05 = 290.083
```

**业务逻辑**：
- 每个稳定区间（余额不变）生成一条记录
- 费率变更时会拆分区间（如 id=2 和 id=3）
- 唯一索引：`(chain_id, contract_address, account, from_time, to_time)`
- 支持幂等性：重复计算不会产生重复记录

---

## 数据一致性验证

### 验证 1：余额一致性

通过 `balance_log` 重建 `user_balance`：

```sql
-- 计算用户 0x8a89...5Dd1 在 Sepolia 链的余额
SELECT SUM(delta) as calculated_balance
FROM balance_log
WHERE chain_id = 11155111
  AND contract_address = '0xBEfe9d9726c3BFD513b6aDd74B243a82b272C073'
  AND account = '0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1';

-- 结果：120 token（与 user_balance 表一致）
-- 计算过程：1000 - 100 - 150 - 90 - 160 - 310 - 70 = 120
```

```sql
-- 计算用户 0x8a89...5Dd1 在 Base Sepolia 链的余额
SELECT SUM(delta) as calculated_balance
FROM balance_log
WHERE chain_id = 84532
  AND contract_address = '0xB8a31EaC0874DC6f5a28FCa601336Ae32c723dF6'
  AND account = '0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1';

-- 结果：620 token（与 user_balance 表一致）
-- 计算过程：1000 - 110 - 130 - 80 - 60 = 620
```

### 验证 2：积分一致性

通过 `user_point_log` 重建 `user_point`：

```sql
-- 计算用户 0x5697...1552 在 Sepolia 链的总积分
SELECT SUM(points) as calculated_points
FROM user_point_log
WHERE chain_id = 11155111
  AND contract_address = '0xBEfe9d9726c3BFD513b6aDd74B243a82b272C073'
  AND account = '0x569744F510D38d7e8E68829f284AAa7F07611552';

-- 结果：1185.722（与 user_point 表一致）
-- 明细：104.400 + 389.050 + 0.165 + 692.107 = 1185.722
```

```sql
-- 计算用户 0x8a89...5Dd1 在 Sepolia 链的总积分
SELECT SUM(points) as calculated_points
FROM user_point_log
WHERE chain_id = 11155111
  AND contract_address = '0xBEfe9d9726c3BFD513b6aDd74B243a82b272C073'
  AND account = '0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1';

-- 结果：1700.763（与 user_point 表一致）
-- 明细：332.167 + 0.450 + 521.875 + 0.110 + 627.500 + 0.101 + 218.560 = 1700.763
```

```sql
-- 计算用户 0x8a89...5Dd1 在 Base Sepolia 链的总积分
SELECT SUM(points) as calculated_points
FROM user_point_log
WHERE chain_id = 84532
  AND contract_address = '0xB8a31EaC0874DC6f5a28FCa601336Ae32c723dF6'
  AND account = '0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1';

-- 结果：818.429（与 user_point 表一致）
-- 明细：290.083 + 0.569 + 527.588 + 0.189 = 818.429
```

### 验证 3：Transfer 事件配对

每笔转账应产生两条 `balance_log` 记录：

```sql
-- 查询交易 0x83ed...fc49 的记录
SELECT account, delta, balance_after
FROM balance_log
WHERE tx_hash = '0x83ed4ac1aa9e72d7932004132afcbf3665ecdd31e978d9f5237c65651df7fc49';

-- 结果：
-- 0x8a89...5Dd1: -100 (转出方)
-- 0xe9FC...c259: +100 (转入方)
-- 验证通过：delta 之和为 0
```

```sql
-- 查询交易 0x97cc...4a8e 的记录
SELECT account, delta, balance_after
FROM balance_log
WHERE tx_hash = '0x97ccc9bc561136b4deaaf7fe5f225d15321d55d05b9d0a49e1bc8a39ad354a8e';

-- 结果：
-- 0x8a89...5Dd1: -310 (转出方)
-- 0xe9FC...c259: +310 (转入方)
-- 验证通过：delta 之和为 0
```

### 验证 4：费率变更时的积分拆分

验证费率从 5% 变更为 8% 时的积分计算：

**用户 0x5697...1552 在费率变更时刻的积分记录**：
- id=2: 余额 310，时间段 2026-01-14 01:55:00 → 2026-01-15 03:01:00，费率 5%，积分 389.050
- id=3: 余额 310，时间段 2026-01-15 03:01:00 → 2026-01-15 03:01:24，费率 8%，积分 0.165
- id=4: 余额 380，时间段 2026-01-15 03:01:24 → 2026-01-16 01:47:24，费率 8%，积分 692.107

**验证通过**：费率在 2026-01-15 03:01:00 变更，系统正确地将积分计算拆分为两个区间。

---

## 数据库设计亮点

1. **事实表 + 快照表架构**：
   - `balance_log` 和 `user_point_log` 为不可变事实表
   - `user_balance` 和 `user_point` 为可重建快照表
   - 保证数据可追溯、可审计

2. **幂等性设计**：
   - 唯一索引防止重复插入
   - 支持程序重启后重新计算
   - 分叉回滚后可重新同步

3. **分叉安全**：
   - `block_header` 存储区块链信息
   - 回滚时删除 > safeBlock 的数据
   - 通过事实表重建快照表

4. **性能优化**：
   - 复合索引：`(chain_id, contract_address, account, block_number)`
   - 快照表加速查询
   - 事实表保证准确性

5. **多链支持**：
   - 通过 `chain_id` 区分不同链
   - 每条链独立同步和计算
   - 支持不同链的不同费率配置

6. **费率动态调整**：
   - 支持按时间段配置不同费率
   - 积分计算时自动拆分区间
   - 历史数据不受影响

---

## 数据脱敏说明

本文档中的所有敏感信息已进行脱敏处理：

- **地址脱敏**：完整地址 `0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1` → `0x8a89...5Dd1`
- **哈希脱敏**：完整哈希 `0x8a6835f048c56d009c883c12ad3539fc19d8404e4f7a2cf4c38c6967d54e52b0` → `0x8a68...52b0`
- **数值简化**：余额从 wei 单位（如 `1000000000000000000000`）转换为 token 单位（如 `1000`）

实际数据库中存储的是完整的地址、哈希和 wei 单位的数值。
