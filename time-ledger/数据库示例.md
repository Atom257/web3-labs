# 数据库示例数据

本文档展示了 Time Ledger 系统中各个核心表的示例数据，帮助理解数据结构和业务逻辑。

> **注意**：所有敏感信息（地址、哈希）已脱敏处理。

## 1. balance_log - 余额变动事实表

记录所有 Transfer 事件导致的余额变动。

| id | chain_id | account | delta | balance_after | block_number | block_time | tx_hash |
|----|----------|---------|-------|---------------|--------------|------------|---------|
| 1 | 11155111 | 0x8a89...5Dd1 | +1000 | 1000 | 10032846 | 2026-01-13 05:20:36 | 0x8a68...52b0 |
| 2 | 11155111 | 0x8a89...5Dd1 | -100 | 900 | 10034697 | 2026-01-13 11:59:12 | 0x83ed...fc49 |
| 3 | 11155111 | 0xe9FC...c259 | +100 | 100 | 10034697 | 2026-01-13 11:59:12 | 0x83ed...fc49 |
| 4 | 11155111 | 0x8a89...5Dd1 | -150 | 750 | 10034699 | 2026-01-13 11:59:48 | 0x3595...8ecf |
| 5 | 11155111 | 0x5697...1552 | +150 | 150 | 10034699 | 2026-01-13 11:59:48 | 0x3595...8ecf |

**关键字段说明**：
- `delta`：余额变动量（正数为收入，负数为支出）
- `balance_after`：变动后的余额快照
- `tx_hash`：同一笔交易会产生两条记录（转出方和转入方）

**业务逻辑**：
- 每个 Transfer 事件产生 2 条记录（from 和 to）
- 唯一索引：`(chain_id, contract_address, account, block_number, log_index)`
- 用于积分计算的事实数据源

---

## 2. block_cursor - 同步进度表

记录每条链的同步进度，用于断点续传。

| id | chain_id | contract_address | block_number | scan_block_number | updated_at |
|----|----------|------------------|--------------|-------------------|------------|
| 4 | 11155111 | 0xBEfe...C073 | 10064675 | 10064675 | 2026-01-17 16:38:58 |
| 5 | 84532 | 0xB8a3...3dF6 | 36293683 | 36315683 | 2026-01-17 16:39:50 |

**关键字段说明**：
- `block_number`：已确认的区块高度（写入数据库）
- `scan_block_number`：已扫描的区块高度（可能在 Redis pending）
- 对于 OP Stack 链：`scan_block_number` > `block_number`（扫描快于确认）

---

## 3. block_header - 区块头信息表

用于 OP Stack 链的分叉检测。

| id | chain_id | block_number | block_hash | parent_hash | block_time |
|----|----------|--------------|------------|-------------|------------|
| 1 | 11155111 | 10032846 | 0x8b3f...0ac5 | 0xf574...5142 | 2026-01-13 05:20:36 |
| 2 | 11155111 | 10034697 | 0x60f5...1860 | 0x7ee6...8560 | 2026-01-13 11:59:12 |
| 9 | 84532 | 36258216 | 0x3cf5...7eac | 0xcdcf...ba29 | 2026-01-13 06:12:00 |

**业务逻辑**：
- 存储最近 N 个区块的哈希（N = reorg_window）
- 定期与链上实际哈希对比，检测分叉
- 发现不一致时触发回滚

---

## 4. point_rate - 积分费率配置表

配置不同时间段的积分计算费率。

| id | chain_id | contract_address | rate_numerator | rate_denominator | effective_time |
|----|----------|------------------|----------------|------------------|----------------|
| 1 | 11155111 | 0xBEfe...C073 | 5 | 100 | 1970-01-01 00:00:00 |
| 2 | 11155111 | 0xBEfe...C073 | 8 | 100 | 2026-01-15 03:01:00 |
| 3 | 84532 | 0xB8a3...3dF6 | 5 | 100 | 1970-01-01 00:00:00 |

**费率说明**：
- 费率 = `rate_numerator / rate_denominator`
- 示例：5/100 = 0.05 (5%)，8/100 = 0.08 (8%)
- 支持动态调整：2026-01-15 之后费率从 5% 提升到 8%

---

## 5. user_balance - 用户余额快照表

存储用户当前余额的最新状态。

| id | chain_id | account | balance | block_number | block_time |
|----|----------|---------|---------|--------------|------------|
| 1 | 11155111 | 0x8a89...5Dd1 | 120 | 10046278 | 2026-01-15 03:01:24 |
| 2 | 11155111 | 0xe9FC...c259 | 430 | 10053039 | 2026-01-16 01:47:24 |
| 3 | 11155111 | 0x5697...1552 | 450 | 10053039 | 2026-01-16 01:47:24 |
| 4 | 84532 | 0x8a89...5Dd1 | 620 | 36293683 | 2026-01-14 01:54:14 |

**业务逻辑**：
- 每次 Transfer 事件后更新
- 可通过 `balance_log` 重建（用于分叉回滚）
- 用于快速查询用户当前余额

---

## 6. user_point - 用户积分快照表

存储用户累计积分的最新状态。

| id | chain_id | account | total_points | last_calc_time |
|----|----------|---------|--------------|----------------|
| 1 | 11155111 | 0x5697...1552 | 1185.722 | 2026-01-16 01:47:24 |
| 2 | 11155111 | 0x8a89...5Dd1 | 1700.763 | 2026-01-16 01:47:24 |
| 3 | 11155111 | 0xe9FC...c259 | 1219.048 | 2026-01-16 01:47:24 |
| 4 | 84532 | 0x8a89...5Dd1 | 818.429 | 2026-01-14 01:54:14 |

**业务逻辑**：
- 每小时整点计算一次
- `last_calc_time`：上次计算的截止时间
- 程序重启后根据 `last_calc_time` 回溯历史积分

---

## 7. user_point_log - 积分计算明细表

记录每个时间段的积分计算详情，用于审计和追溯。

| id | chain_id | account | balance | from_time | to_time | points | rate |
|----|----------|---------|---------|-----------|---------|--------|------|
| 1 | 11155111 | 0x5697...1552 | 150 | 2026-01-13 11:59:48 | 2026-01-14 01:55:00 | 104.40 | 5% |
| 2 | 11155111 | 0x5697...1552 | 310 | 2026-01-14 01:55:00 | 2026-01-15 03:01:00 | 389.05 | 5% |
| 3 | 11155111 | 0x5697...1552 | 310 | 2026-01-15 03:01:00 | 2026-01-15 03:01:24 | 0.17 | 8% |
| 4 | 11155111 | 0x5697...1552 | 380 | 2026-01-15 03:01:24 | 2026-01-16 01:47:24 | 692.11 | 8% |

**积分计算示例**：

以 id=1 为例：
```
余额：150 token
时长：2026-01-13 11:59:48 → 2026-01-14 01:55:00 = 13小时55分12秒 ≈ 13.92 小时
费率：5% = 0.05
积分：150 × 13.92 × 0.05 = 104.40
```

以 id=3 为例（费率变更时刻）：
```
余额：310 token
时长：2026-01-15 03:01:00 → 2026-01-15 03:01:24 = 24秒 ≈ 0.00667 小时
费率：8% = 0.08（新费率生效）
积分：310 × 0.00667 × 0.08 = 0.17
```

**业务逻辑**：
- 每个稳定区间（余额不变）生成一条记录
- 费率变更时会拆分区间
- 唯一索引：`(chain_id, contract_address, account, from_time, to_time)`
- 支持幂等性：重复计算不会产生重复记录

---

## 数据一致性验证

### 验证 1：余额一致性

通过 `balance_log` 重建 `user_balance`：

```sql
-- 计算用户 0x8a89...5Dd1 在 Sepolia 链的余额
SELECT SUM(delta) as calculated_balance
FROM balance_log
WHERE chain_id = 11155111
  AND contract_address = '0xBEfe9d9726c3BFD513b6aDd74B243a82b272C073'
  AND account = '0x8a89a8FA663845284a645f95C5d87Ba1D1d25Dd1';

-- 结果：120 token（与 user_balance 表一致）
```

### 验证 2：积分一致性

通过 `user_point_log` 重建 `user_point`：

```sql
-- 计算用户 0x5697...1552 的总积分
SELECT SUM(points) as calculated_points
FROM user_point_log
WHERE chain_id = 11155111
  AND contract_address = '0xBEfe9d9726c3BFD513b6aDd74B243a82b272C073'
  AND account = '0x569744F510D38d7e8E68829f284AAa7F07611552';

-- 结果：1185.722（与 user_point 表一致）
-- 明细：104.40 + 389.05 + 0.17 + 692.11 = 1185.73
```

### 验证 3：Transfer 事件配对

每笔转账应产生两条 `balance_log` 记录：

```sql
-- 查询交易 0x83ed...fc49 的记录
SELECT account, delta, balance_after
FROM balance_log
WHERE tx_hash = '0x83ed4ac1aa9e72d7932004132afcbf3665ecdd31e978d9f5237c65651df7fc49';

-- 结果：
-- 0x8a89...5Dd1: -100 (转出方)
-- 0xe9FC...c259: +100 (转入方)
-- 验证通过：delta 之和为 0
```

---

## 数据库设计亮点

1. **事实表 + 快照表**：
   - `balance_log` 和 `user_point_log` 为不可变事实表
   - `user_balance` 和 `user_point` 为可重建快照表
   - 保证数据可追溯、可审计

2. **幂等性设计**：
   - 唯一索引防止重复插入
   - 支持程序重启后重新计算

3. **分叉安全**：
   - `block_header` 存储区块链信息
   - 回滚时删除 > safeBlock 的数据
   - 通过事实表重建快照表

4. **性能优化**：
   - 复合索引：`(chain_id, contract_address, account, block_number)`
   - 快照表加速查询
   - 事实表保证准确性
